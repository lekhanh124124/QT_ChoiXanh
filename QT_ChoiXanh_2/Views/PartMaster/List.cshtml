@{
    ViewData["Title"] = "Chuyển nhóm bài viết";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="tieudechinh">
    <div class="col-md-7">
        <section class="content-header"><h1>CHUYỂN NHÓM BÀI VIẾT QUA CHUYÊN MỤC KHÁC</h1></section>
    </div>
    <div class="col-md-5 pull-right right">
        <a href="/admin/part/partmaster/list-full.asp?act=3&gdc=9" class="btn btn-success"><i class="fa fa-sign-out"></i> Nhóm danh mục</a>
        <a href="/Admin/ExportBaiViet" class="btn btn-info"><i class="fa fa-sign-out"></i> Export</a>
    </div>
</div>

<div class="khung">
    <div class="right">
        Giảm bớt cột:
        <a class="toggle-vis btn btn-xs btn-info" data-column="0">ID</a>
        <a class="toggle-vis btn btn-xs btn-default" data-column="1">Tiêu đề</a>
        <a class="toggle-vis btn btn-xs btn-primary" data-column="2">Chức năng</a>
    </div>
    <table id="danhsachyeucau" class="display" style="width: 100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>Tiêu đề</th>
                <th>Chức năng</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<span class="formthongbaopopupcenter"></span>
<span class="formthongbaomoipopup"></span>
<span id="boxes" style="display:none"></span>
<div class="modal fade" id="thongbaoHeThongModal" tabindex="-1" role="dialog" aria-labelledby="thongbaoHeThongModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span>×</span></button>
                <h5 class="modal-title" id="thongbaoHeThongModalLabel"></h5>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer box-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
<div id="notification" class="notification position-fixed top-0 end-0 bg-primary text-white p-3 m-3 rounded" style="top: 20px; right: 20px; z-index: 999; display:none"></div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var drawCounter = 1; // Biến đếm draw counter
            
            var table = $('#danhsachyeucau').DataTable({
                "serverSide": true, // Bật server-side processing
                "ajax": {
                    "url": "https://demodienmay.125.atoz.vn/admin/api/web.danhsach.partmaster.asp",
                    "type": "GET",
                    "data": function(d) {
                        // Tính toán pageid dựa trên start và length
                        var currentPage = Math.floor(d.start / d.length) + 1;
                        
                        // Xây dựng parameters theo định dạng yêu cầu của API
                        var params = {
                            'draw': drawCounter,
                            'start': d.start,
                            'length': d.length,
                            'pageid': currentPage,
                            'search[value]': d.search.value || '',
                            'search[regex]': false,
                            'order[0][column]': d.order[0].column || 0,
                            'order[0][dir]': d.order[0].dir || 'asc'
                        };
                        
                        // Thêm thông tin columns
                        d.columns.forEach(function(column, index) {
                            params['columns[' + index + '][data]'] = column.data;
                            params['columns[' + index + '][name]'] = column.name || '';
                            params['columns[' + index + '][searchable]'] = column.searchable;
                            params['columns[' + index + '][orderable]'] = column.orderable;
                            params['columns[' + index + '][search][value]'] = column.search.value || '';
                            params['columns[' + index + '][search][regex]'] = column.search.regex || false;
                        });
                        
                        return params;
                    },
                    "dataSrc": function(json) {
                        // Increment draw counter for next request
                        drawCounter++;
                        return json.data;
                    }
                },
                "columns": [
                    { "data": "id" },
                    { "data": "tieude" },
                    {
                        "data": "idquanly",
                        "orderable": false,
                        "render": function(data, type, row) {
                            var id = row.id;
                            var capmenu = row.idquanly;
                            if (capmenu == "0") {
                                return `<a class="btn btn-default btn-xs" href="/Admin/QuanLyNhomDanhMuc?id=${id}" title="Quản lý nhóm danh mục"><i class="tdicon fa fa-folder-open-o"></i></a> <a href="/Admin/QuanLyNhomDanhMuc?id=${id}" title="Chuyển nhóm danh mục">Chuyển</a>`;
                            } else {
                                return `<a class="btn btn-warning btn-xs" href="/Admin/Part/Edit?IDPart=${id}" title="Sửa bài viết"><i class="tdicon fa fa-edit"></i></a>
                                        <a class="btn btn-success btn-xs" href="/Admin/Part/ChuyenBaiViet?IDPart=${id}" title="Chuyển bài viết"><i class="tdicon fa fa-exchange"></i></a>
                                        <a class="btn btn-danger btn-xs divreload" href="javascript:void(0)" data-fancybox data-type="ajax" data-src="/Admin/Part/Delete?IDPart=${id}" title="Xóa bài viết"><i class="fa fa-close"></i></a>`;
                            }
                        }
                    }
                ],
                "order": [[0, "asc"]],
                "responsive": true,
                "pageLength": 100,
                "lengthMenu": [[10, 25, 50, 100, 1000], [10, 25, 50, 100, 1000]],
                "searching": false, // Tắt thanh tìm kiếm
                "lengthChange": true, // Bật chọn số kết quả
                "ordering": true,
                "colReorder": true,
                "language": {
                    "lengthMenu": "Hiển thị _MENU_ kết quả",
                    "info": "Hiển thị _START_ đến _END_ [_TOTAL_]",
                    "processing": "Đang xử lý dữ liệu...",
                    "emptyTable": "Không có dữ liệu",
                    "paginate": {
                        "previous": "Trước",
                        "next": "Kế"
                    }
                }
            });

            // Xử lý bật/tắt cột
            $('.toggle-vis').on('click', function (e) {
                e.preventDefault();
                var column = table.column($(this).attr('data-column'));
                column.visible(!column.visible());
            });

            // Hàm choose để thay đổi pageid - cập nhật để sử dụng với server-side processing
            window.choose = function(loai) {
                // Reset về trang đầu khi thay đổi pageid filter
                table.page(0).draw('page');
            };
        });
    </script>
}